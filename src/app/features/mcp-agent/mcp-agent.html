<div class="mcp-agent">
  <h2 class="title">
    <i class="fas fa-robot mr-2"></i> AI Analysis
  </h2>

  <form [formGroup]="form" (ngSubmit)="submit()">
    <div class="form-group">
      <textarea
        formControlName="question"
        rows="3"
        placeholder="Ask about dividends, financials, or stock state..."
      ></textarea>
    </div>

    <div class="form-actions">
      <p-button
        type="submit"
        label="Ask AI"
        icon="pi pi-send"
        styleClass="p-button-primary"
        [disabled]="loading()"
      ></p-button>
    </div>
  </form>

  @if (loading()) {
    <div class="loading">Thinking...</div>
  }
  @if (error()) {
    <div class="error">{{ error() }}</div>
  }
</div>

<!-- Render structured AgentUIResponse (full-width) -->
@if (answer()) {
  <section class="ai-output" style="margin-left:2rem; margin-right:2rem; padding-bottom:6rem; margin-bottom:2rem;">
    <div class="answer">

      <!-- 1) HTML snippet (safe, short summary) -->
      @if (answer()?.html) {
        <div class="ai-html" [innerHTML]="answer()!.html"></div>
      }

      <!-- 2) Meta (ticker, asOf, notes, rowCount, etc.) -->
      @if (answer()?.ui?.meta) {
        <div class="ai-meta">
          <div class="meta-line">
            @if (answer()?.ui?.meta?.ticker) {
              <span class="meta-chip"><strong>Ticker:</strong> {{ answer()!.ui!.meta!.ticker }}</span>
            }
            @if (answer()?.ui?.meta?.asOf) {
              <span class="meta-chip"><strong>As of:</strong> {{ answer()!.ui!.meta!.asOf }}</span>
            }
            @if (answer()?.ui?.meta?.['rowCount']) {
              <span class="meta-chip"><strong>Rows:</strong> {{ answer()!.ui!.meta!['rowCount'] }}</span>
            }
          </div>
          @if (Array.isArray($any(answer()?.ui?.meta)?.notes) && ($any(answer()?.ui?.meta)?.notes.length > 0)) {
            <ul class="meta-notes">
              @for (n of ($any(answer()?.ui?.meta)?.notes || []); track $index) {
                <li>{{ n }}</li>
              }
            </ul>
          }
        </div>
      }

      <!-- 3) Tables -->
      @if (answer()?.ui?.tables?.length) {
        <div class="ai-tables">
          @for (tbl of answer()!.ui!.tables!; track tbl.id) {
            <div class="ai-table-card" style="overflow:auto; margin-bottom:2rem;">
              @if (tbl.title) {
                <h3 class="table-title">{{ tbl.title }}</h3>
              }
              <p-table
                [value]="tbl.rows ?? []"
                [tableStyle]="{ 'min-width': '60rem' }"
                [scrollable]="true"
                scrollHeight="flex"
                styleClass="p-datatable-sm"
              >
                <ng-template pTemplate="header">
                  <tr>
                    @for (col of tbl.columns; track col.field) {
                      <th>{{ col.header }}</th>
                    }
                  </tr>
                </ng-template>

                <ng-template pTemplate="body" let-row>
                  <tr>
                    @for (col of tbl.columns; track col.field) {
                      <td>{{ row[col.field] }}</td>
                    }
                  </tr>
                </ng-template>
              </p-table>
            </div>
          }
        </div>
      }

      <!-- 4) Charts -->
      @if (answer()?.ui?.charts?.length) {
        <div class="ai-charts">
          @for (c of answer()!.ui!.charts!; track c.id) {
            <div class="chart-card" style="margin-bottom:2rem;">
              @if (c.title) { <h3 class="chart-title">{{ c.title }}</h3> }
              <p-chart
                [type]="c.type"
                [data]="c.data"
                [options]="c.options"
                class="w-full h-[24rem]"
              ></p-chart>
            </div>
          }
        </div>
      }

      <!-- 5) Fallback when no visual payload -->
      @if (!(answer()?.ui?.tables?.length) && !(answer()?.ui?.charts?.length) && !answer()?.html) {
        <p class="muted">No structured output to display.</p>
      }
    </div>
  </section>
  <div class="footer-spacer" style="height:72px;"></div>
}