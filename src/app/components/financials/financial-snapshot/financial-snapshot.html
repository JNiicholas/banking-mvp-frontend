<!-- Header -->
<h2 class="page-title">Financial snapshot</h2>

<!-- Ticker picker -->
<div class="toolbar">
  <div class="auto-wrap">
    <app-ticker-autocomplete
      [placeholder]="'Search ticker…'"
      (picked)="onPick($event)"
      (cleared)="onClear()">
    </app-ticker-autocomplete>
  </div>
  <div class="date-wrap">
    <p-datepicker
      [(ngModel)]="rangeDates"
      selectionMode="range"
      [readonlyInput]="true"
      (ngModelChange)="onRangeChange()">
    </p-datepicker>
  </div>
</div>

<!-- Empty state -->
<div *ngIf="!summary" class="empty">
  <p>Select a ticker to load a financial snapshot.</p>
</div>

<!-- Snapshot content -->
<div *ngIf="summary as s" class="snapshot">
  <!-- Meta -->
  <section class="card">
    <h3>Meta</h3>
    <div class="grid">
      <div><strong>Ticker:</strong> {{ s.meta?.ticker }}</div>
      <div><strong>Company:</strong> {{ s.meta?.company_name || '—' }}</div>
      <div><strong>Currency:</strong> {{ s.meta?.currency || '—' }}</div>
      <div><strong>Unit:</strong> {{ s.meta?.unit || '—' }}</div>
      <div><strong>Periodicity:</strong> {{ s.meta?.periodicity }}</div>
      <div><strong>As of:</strong> {{ s.meta?.asof | date:'yyyy-MM-dd' }}</div>
      <div><strong>Version:</strong> {{ s.meta?.version || '—' }}</div>
    </div>
  </section>

  <!-- Latest period -->
  <section class="card" *ngIf="s.latest as L">
    <h3>Latest Period</h3>
    <div class="grid">
      <div><strong>Fiscal:</strong> {{ L.fiscal_year }} {{ L.fiscal_period || 'FY' }}</div>
      <div><strong>Period End:</strong> {{ L.period_end_date | date:'yyyy-MM-dd' }}</div>
    </div>

    <div class="cols">
      <div class="col">
        <h4>Income</h4>
        <table>
          <tr><td>Revenue</td><td class="num">{{ L.income?.revenues | number:'1.0-0' }}</td></tr>
          <tr><td>Gross Profit</td><td class="num">{{ L.income?.gross_profit | number:'1.0-0' }}</td></tr>
          <tr><td>Operating Income</td><td class="num">{{ L.income?.operating_income_loss | number:'1.0-0' }}</td></tr>
          <tr><td>Net Income</td><td class="num">{{ L.income?.net_income_loss | number:'1.0-0' }}</td></tr>
          <tr><td>Diluted EPS</td><td class="num">{{ L.income?.diluted_earnings_per_share | number:'1.2-2' }}</td></tr>
          <tr><td>Avg Diluted Shares</td><td class="num">{{ L.income?.diluted_average_shares | number:'1.0-0' }}</td></tr>
        </table>
      </div>
      <div class="col">
        <h4>Cash Flow</h4>
        <table>
          <tr><td>Operating CF</td><td class="num">{{ L.cashflow?.net_cash_flow_from_operating_activities | number:'1.0-0' }}</td></tr>
          <tr><td>Investing CF</td><td class="num">{{ L.cashflow?.net_cash_flow_from_investing_activities | number:'1.0-0' }}</td></tr>
          <tr><td>Financing CF</td><td class="num">{{ L.cashflow?.net_cash_flow_from_financing_activities | number:'1.0-0' }}</td></tr>
          <tr><td>Net Cash Flow</td><td class="num">{{ L.cashflow?.net_cash_flow | number:'1.0-0' }}</td></tr>
        </table>
      </div>
      <div class="col">
        <h4>Ratios</h4>
        <table>
          <tr><td>Gross Margin</td><td class="num">{{ L.ratios?.gross_margin | percent:'1.1-1' }}</td></tr>
          <tr><td>Operating Margin</td><td class="num">{{ L.ratios?.operating_margin | percent:'1.1-1' }}</td></tr>
          <tr><td>Net Margin</td><td class="num">{{ L.ratios?.net_margin | percent:'1.1-1' }}</td></tr>
          <tr><td>ROA</td><td class="num">{{ L.ratios?.return_on_assets | percent:'1.1-1' }}</td></tr>
          <tr><td>ROE</td><td class="num">{{ L.ratios?.return_on_equity | percent:'1.1-1' }}</td></tr>
          <tr><td>Debt/Equity</td><td class="num">{{ L.ratios?.debt_to_equity | number:'1.2-2' }}</td></tr>
        </table>
      </div>
    </div>
  </section>

  <!-- TTM block -->
  <section class="card" *ngIf="s.trailing_twelve_months as ttm">
    <h3>Trailing Twelve Months</h3>
    <div class="cols">
      <div class="col">
        <table>
          <tr><td>Revenue (TTM)</td><td class="num">{{ ttm.revenues | number:'1.0-0' }}</td></tr>
          <tr><td>Gross Profit (TTM)</td><td class="num">{{ ttm.gross_profit | number:'1.0-0' }}</td></tr>
          <tr><td>Operating Income (TTM)</td><td class="num">{{ ttm.operating_income | number:'1.0-0' }}</td></tr>
          <tr><td>Net Income (TTM)</td><td class="num">{{ ttm.net_income | number:'1.0-0' }}</td></tr>
        </table>
      </div>
      <div class="col">
        <table>
          <tr><td>Operating CF (TTM)</td><td class="num">{{ ttm.operating_cash_flow | number:'1.0-0' }}</td></tr>
          <tr><td>Free Cash Flow (TTM)</td><td class="num">{{ ttm.free_cash_flow | number:'1.0-0' }}</td></tr>
          <tr><td>Diluted EPS (TTM)</td><td class="num">{{ ttm.diluted_eps | number:'1.2-2' }}</td></tr>
          <tr><td>Avg Diluted Shares (TTM)</td><td class="num">{{ ttm.shares_diluted_avg | number:'1.0-0' }}</td></tr>
        </table>
      </div>
      <div class="col">
        <h4>Margins (TTM)</h4>
        <table>
          <tr><td>Gross</td><td class="num">{{ ttm.margins?.gross | percent:'1.1-1' }}</td></tr>
          <tr><td>Operating</td><td class="num">{{ ttm.margins?.operating | percent:'1.1-1' }}</td></tr>
          <tr><td>Net</td><td class="num">{{ ttm.margins?.net | percent:'1.1-1' }}</td></tr>
          <tr><td>OCF Margin</td><td class="num">{{ ttm.margins?.ocf | percent:'1.1-1' }}</td></tr>
        </table>
      </div>
    </div>
  </section>

  <!-- Previous TTM (comparison) -->
  <section class="card" *ngIf="s.history?.ttm_prev as ttmPrev">
    <h3>Previous TTM (vs latest)</h3>
    <div class="cols">
      <div class="col">
        <table>
          <tr>
            <td></td>
            <td class="num muted">Prev TTM</td>
            <td class="num">Latest TTM</td>
            <td class="num">Δ %</td>
          </tr>
          <tr>
            <td>Revenue</td>
            <td class="num muted">{{ ttmPrev.revenues | number:'1.0-0' }}</td>
            <td class="num">{{ s.trailing_twelve_months?.revenues | number:'1.0-0' }}</td>
            <td class="num" [class.pos]="(s.trailing_twelve_months?.revenues ?? 0) - (ttmPrev.revenues ?? 0) >= 0" [class.neg]="(s.trailing_twelve_months?.revenues ?? 0) - (ttmPrev.revenues ?? 0) < 0">
              {{ ((s.trailing_twelve_months?.revenues ?? 0) - (ttmPrev.revenues ?? 0)) / (ttmPrev.revenues || 1) | percent:'1.1-1' }}
            </td>
          </tr>
          <tr>
            <td>Operating Income</td>
            <td class="num muted">{{ ttmPrev.operating_income | number:'1.0-0' }}</td>
            <td class="num">{{ s.trailing_twelve_months?.operating_income | number:'1.0-0' }}</td>
            <td class="num" [class.pos]="(s.trailing_twelve_months?.operating_income ?? 0) - (ttmPrev.operating_income ?? 0) >= 0" [class.neg]="(s.trailing_twelve_months?.operating_income ?? 0) - (ttmPrev.operating_income ?? 0) < 0">
              {{ ((s.trailing_twelve_months?.operating_income ?? 0) - (ttmPrev.operating_income ?? 0)) / (ttmPrev.operating_income || 1) | percent:'1.1-1' }}
            </td>
          </tr>
          <tr>
            <td>Net Income</td>
            <td class="num muted">{{ ttmPrev.net_income | number:'1.0-0' }}</td>
            <td class="num">{{ s.trailing_twelve_months?.net_income | number:'1.0-0' }}</td>
            <td class="num" [class.pos]="(s.trailing_twelve_months?.net_income ?? 0) - (ttmPrev.net_income ?? 0) >= 0" [class.neg]="(s.trailing_twelve_months?.net_income ?? 0) - (ttmPrev.net_income ?? 0) < 0">
              {{ ((s.trailing_twelve_months?.net_income ?? 0) - (ttmPrev.net_income ?? 0)) / (ttmPrev.net_income || 1) | percent:'1.1-1' }}
            </td>
          </tr>
          <tr>
            <td>Operating CF</td>
            <td class="num muted">{{ ttmPrev.operating_cash_flow | number:'1.0-0' }}</td>
            <td class="num">{{ s.trailing_twelve_months?.operating_cash_flow | number:'1.0-0' }}</td>
            <td class="num" [class.pos]="(s.trailing_twelve_months?.operating_cash_flow ?? 0) - (ttmPrev.operating_cash_flow ?? 0) >= 0" [class.neg]="(s.trailing_twelve_months?.operating_cash_flow ?? 0) - (ttmPrev.operating_cash_flow ?? 0) < 0">
              {{ ((s.trailing_twelve_months?.operating_cash_flow ?? 0) - (ttmPrev.operating_cash_flow ?? 0)) / (ttmPrev.operating_cash_flow || 1) | percent:'1.1-1' }}
            </td>
          </tr>
        </table>
      </div>
      <div class="col">
        <h4>Rolling TTM coverage</h4>
        <p class="muted">Points: {{ s.history?.ttm_points?.length || 0 }}</p>
        <p class="muted" *ngIf="s.history?.ttm_points?.length">From {{ s.history!.ttm_points![0].period_end_date | date:'yyyy-MM-dd' }} to {{ s.history!.ttm_points![s.history!.ttm_points!.length-1].period_end_date | date:'yyyy-MM-dd' }}</p>
      </div>
    </div>
  </section>

  <!-- Recent quarters (compact table) -->
  <section class="card" *ngIf="s.history?.recent_quarters?.length">
    <h3>Recent quarters</h3>
    <div class="table-scroll">
      <table class="wide">
        <thead>
          <tr>
            <th>Fiscal</th>
            <th>End</th>
            <th class="num">Revenue</th>
            <th class="num">Op. Income</th>
            <th class="num">Net Income</th>
            <th class="num">Diluted EPS</th>
            <th class="num">OCF</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let q of s.history!.recent_quarters">
            <td>{{ q.fiscal_year }} {{ q.fiscal_period || 'FY' }}</td>
            <td>{{ q.period_end_date | date:'yyyy-MM-dd' }}</td>
            <td class="num">{{ q.revenue | number:'1.0-0' }}</td>
            <td class="num">{{ q.operating_income | number:'1.0-0' }}</td>
            <td class="num">{{ q.net_income | number:'1.0-0' }}</td>
            <td class="num">{{ q.diluted_eps | number:'1.2-2' }}</td>
            <td class="num">{{ q.ocf | number:'1.0-0' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Deltas -->
  <section class="card" *ngIf="s.deltas as d">
    <h3>Change</h3>
    <div class="grid">
      <div><strong>Revenue QoQ:</strong> <span class="num">{{ d.revenue_qoq | percent:'1.1-1' }}</span></div>
      <div><strong>Revenue YoY:</strong> <span class="num">{{ d.revenue_yoy | percent:'1.1-1' }}</span></div>
      <div><strong>EPS YoY:</strong> <span class="num">{{ d.eps_yoy | percent:'1.1-1' }}</span></div>
      <div><strong>Net Income YoY:</strong> <span class="num">{{ d.net_income_yoy | percent:'1.1-1' }}</span></div>
    </div>
  </section>
</div>

<!-- Lightweight styles to make it readable without SCSS yet -->
<style>
  .page-title { margin: .25rem 0 .5rem; font-size: 1.375rem; font-weight: 600; }
  .toolbar { display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; }
  .date-wrap { flex-shrink: 0; }
  .date-wrap { min-width: 340px; max-width: 420px; }
  .auto-wrap { flex: 1; min-width: 360px; max-width: 500px; }
  .snapshot { display: grid; gap: 1rem; padding-bottom: 6rem; }
  .card { padding: 1rem; border: 1px solid #334155; border-radius: 8px; background: #111827; color: #e5e7eb; }
  .card h3, .card h4 { color: #f3f4f6; }
  .card strong { color: #f9fafb; }
  .card table tr + tr td { border-top: 1px solid rgba(148,163,184,.12); }
  .card h3 { margin: 0 0 .5rem; }
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: .5rem 1rem; }
  .cols { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; }
  table { width: 100%; border-collapse: collapse; }
  td { padding: .25rem 0; color: inherit; }
  td.num { text-align: right; font-variant-numeric: tabular-nums; }
  .empty { color: #94a3b8; font-style: italic; }
  .muted { color: #a3a3a3; }
  .pos { color: #22c55e; }
  .neg { color: #ef4444; }
  .table-scroll { overflow:auto; }
  table.wide { width: 100%; }
  table.wide th { text-align: left; font-weight: 600; padding: .25rem 0; }
  table.wide th.num { text-align: right; }
</style>
