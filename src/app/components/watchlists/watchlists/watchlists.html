<div class="wl-container">
    <h2>Watchlists</h2>

    @if (loading) {
    <div class="status">Loading…</div>
    }
    @if (error) {
    <div class="error">{{ error }}</div>
    }

    <!-- Create form (visible when navigated to /watchlists/new) -->
    @if (isCreating()) {
    <!-- form prevents navigation; ngSubmit handles submit -->
    <form class="create-form" (ngSubmit)="onCreateSubmit($event)" novalidate>
        <fieldset id="create-form" class="create" [disabled]="loading">
            <legend>Create new watchlist</legend>

            <div class="toolbar top">
                <button type="button" class="linklike" (click)="$event.preventDefault(); onBackToLists($event)">← Back
                    to lists</button>
            </div>

            <div class="row">
                <label for="wl-name">Name</label>
                <input id="wl-name" name="name" type="text" [(ngModel)]="newName" placeholder="e.g. Tech Radar"
                    (keydown.enter)="$event.preventDefault(); onCreateClick($event)" />
            </div>

            <div class="row">
                <label for="wl-desc">Description</label>
                <input id="wl-desc" name="description" type="text" [(ngModel)]="newDescription" placeholder="Optional"
                    (keydown.enter)="$event.preventDefault(); onCreateClick($event)" />
            </div>

            <div class="row">
                <label for="wl-tickers">Tickers (CSV)</label>
                <input id="wl-tickers" name="tickers" type="text" [(ngModel)]="newTickersCSV"
                    placeholder="AAPL, MSFT, NVDA" (keydown.enter)="$event.preventDefault(); onCreateClick($event)" />
            </div>

            <div class="row inline">
                <label class="chk" for="wl-default">
                    <input id="wl-default" name="isDefault" type="checkbox" [(ngModel)]="newIsDefault" />
                    Default
                </label>

                <button type="button" class="btn primary" (click)="onCreateClick($event)">
                    Create
                </button>
            </div>
        </fieldset>
    </form>

    <hr />
    }

    @if (!loading && watchlists.length === 0) {
    <div class="empty">No watchlists yet.</div>
    }

    @if (watchlists.length) {
    <p-tabs [(value)]="activeTab" scrollable>
        <p-tablist>
            @for (w of watchlists; track trackById($index, w)) {
            <p-tab [value]="$index" class="flex items-center !gap-2">
                <span class="font-bold whitespace-nowrap">{{ w.name }}</span>
                <p-badge [value]="$any(w)?.tickers?.length || 0" styleClass="ml-2" />
                @if (w.isDefault) { <p-badge value="Default" styleClass="ml-2" /> }
            </p-tab>
            }
        </p-tablist>
        <p-tabpanels>
            @for (w of watchlists; track trackById($index, w)) {
            <p-tabpanel [value]="$index">
                <div class="card">
                    @if (editingId() !== getId(w)) {
                    <div class="card-head">
                        <h3 class="name">{{ w.name }}</h3>
                        <div class="meta">
                            @if (w.isDefault) { <span class="badge">Default</span> }
                            <span class="dates">Created: {{ w.createdAt | date:'yyyy-MM-dd HH:mm' }} · Updated: {{
                                w.updatedAt | date:'yyyy-MM-dd HH:mm' }}</span>
                        </div>
                    </div>
                    @if (w.description) { <p class="desc">{{ w.description }}</p> }

                    @if ($any(w)?.tickers?.length) {
                    <div class="items" [attr.data-count]="($any(w)?.tickers?.length) || 0">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Symbol</th>
                                    <th>Notes</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (it of $any(w).tickers; track it.symbol) {
                                <tr>
                                    <td>{{ it.position }}</td>
                                    <td>{{ it.symbol }}</td>
                                    <td>{{ it.notes }}</td>
                                    <td class="actions">
                                        <button type="button" (click)="removeItem(w, it.symbol)"
                                            [disabled]="loading">Remove</button>
                                    </td>
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    }

                    <div class="toolbar">
                        <button type="button" (click)="beginEdit(w)" [disabled]="loading">Edit</button>
                        <button type="button" (click)="deleteWatchlist(w)" [disabled]="loading">Delete</button>
                    </div>

                    <div class="inline-ops">
                        <div class="row">
                            <label>Add tickers (CSV)</label>
                            <input #addCsv type="text" placeholder="e.g. GOOGL, AMD" />
                            <button type="button" (click)="addItems(w, addCsv.value); addCsv.value = ''"
                                [disabled]="loading">Add</button>
                        </div>
                        <div class="row">
                            <label>Reorder (CSV, full order)</label>
                            <input #orderCsv type="text" placeholder="e.g. MSFT, AAPL, NVDA" />
                            <button type="button" (click)="reorderSymbols(w, orderCsv.value); orderCsv.value = ''"
                                [disabled]="loading">Apply</button>
                        </div>
                    </div>
                    } @else {
                    <div class="edit">
                        <div class="row">
                            <label>Name</label>
                            <input type="text" [(ngModel)]="editName" />
                        </div>
                        <div class="row">
                            <label>Description</label>
                            <input type="text" [(ngModel)]="editDescription" />
                        </div>
                        <div class="row inline">
                            <label class="chk">
                                <input type="checkbox" [(ngModel)]="editIsDefault" /> Default
                            </label>
                        </div>
                        <div class="toolbar">
                            <button type="button" (click)="saveEdit(w)" [disabled]="loading">Save</button>
                            <button type="button" (click)="cancelEdit()">Cancel</button>
                        </div>
                    </div>
                    }
                </div>
            </p-tabpanel>
            }
        </p-tabpanels>
    </p-tabs>
    }
</div>