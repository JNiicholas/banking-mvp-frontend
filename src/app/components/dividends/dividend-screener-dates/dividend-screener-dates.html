<div>
<h2 class="text-xl font-bold mb-4 mt-4">Date Screener</h2>

<div class="controls mb-4 mt-4">
    
    <!-- Ticker -->
    <div class="control">
        <label class="block mb-2 font-medium" for="ticker">Ticker</label>
    <!--  
        <p-iconfield iconPosition="left" class="w-full">
            <p-inputicon>
                <i class="pi pi-search"></i>
            </p-inputicon>
            <input id="ticker" type="text" pInputText [(ngModel)]="ticker" placeholder="e.g. O, AAPL"
                (keyup.enter)="handleSearch()" />
        </p-iconfield>
    -->
          <app-ticker-autocomplete [placeholder]="'Find ticker…'" [minLength]="1" [limit]="20" [disabled]="loadingTickers"
        (picked)="onTickerPicked($event)" (queryChange)="onQueryChanged($event)" (enter)="handleSearch()"
        (cleared)="clearTicker()"></app-ticker-autocomplete>
    </div>

    <!-- Dividend Type (multi-select) -->
    <div class="control">
        <label class="block mb-2 font-medium" for="typeSelect">Dividend Type</label>
        <p-multiselect inputId="typeSelect" [options]="dividendTypeOptions" [(ngModel)]="dividendTypes"
            optionLabel="label" optionValue="value" display="chip" [showClear]="true" placeholder="Any type"
            class="w-full md:w-64">
        </p-multiselect>
    </div>



    <!-- Frequency -->
    <div class="control">
        <label class="block mb-2 font-medium" for="freqSelect">Frequency</label>
        <p-select inputId="freqSelect" [options]="frequencyOptions" [(ngModel)]="freq" optionLabel="label"
            optionValue="value" [checkmark]="true" [showClear]="true" placeholder="Any frequency"
            class="w-full md:w-56">
        </p-select>
    </div>


    <!-- Actions -->
    <div class="control control-actions">
        <button pButton type="button" [label]="loading() ? 'Searching…' : 'Search'" (click)="handleSearch()"
            [disabled]="loading()"></button>
        <button pButton type="button" class="p-button-text" label="Clear" (click)="clear()"></button>
    </div>

</div>

<!-- Advanced Filters Accordion -->
<p-accordion class="mt-2">
    <p-accordion-panel value="advanced">
        <p-accordion-header>
            <ng-template #toggleicon let-active="active">
                @if (active) {
                <i class="pi pi-minus"></i>
                } @else {
                <i class="pi pi-plus"></i>
                }
            </ng-template>
            <span class="flex items-center gap-2 w-full">
                <i class="pi pi-sliders-h"></i>
                <span class="font-bold whitespace-nowrap">Advanced Filters</span>
            </span>
        </p-accordion-header>
        <p-accordion-content>
            <div class="controls mt-2">
                <!-- Cash amount min/max -->
                <div class="control">
                    <label class="block mb-2 font-medium" for="cashMin">Min Amount</label>
                    <p-inputnumber inputId="cashMin" [(ngModel)]="cashMin" [showButtons]="true"
                        buttonLayout="horizontal" spinnerMode="horizontal" [step]="0.01" mode="currency" currency="USD"
                        class="w-full">
                    </p-inputnumber>
                </div>

                <div class="control">
                    <label class="block mb-2 font-medium" for="cashMax">Max Amount</label>
                    <p-inputnumber inputId="cashMax" [(ngModel)]="cashMax" [showButtons]="true"
                        buttonLayout="horizontal" spinnerMode="horizontal" [step]="0.01" mode="currency" currency="USD"
                        class="w-full">
                    </p-inputnumber>
                </div>

                <!-- Ex-dividend date range -->
                <div class="control">
                    <label class="block mb-2 font-medium" for="exRange">Ex-Dividend Date Range</label>
                    <p-floatlabel>
                        <p-datepicker inputId="exRange" [(ngModel)]="exRange" selectionMode="range"
                            [readonlyInput]="true" [showIcon]="true">
                        </p-datepicker>
                        <label for="exRange">Pick a range</label>
                    </p-floatlabel>
                </div>

                <!-- Record date range -->
                <div class="control">
                    <label class="block mb-2 font-medium" for="recordRange">Record Date Range</label>
                    <p-floatlabel>
                        <p-datepicker inputId="recordRange" [(ngModel)]="recordRange" selectionMode="range"
                            [readonlyInput]="true" [showIcon]="true">
                        </p-datepicker>
                        <label for="recordRange">Pick a range</label>
                    </p-floatlabel>
                </div>

                <!-- Declaration date range -->
                <div class="control">
                    <label class="block mb-2 font-medium" for="declarationRange">Declaration Date Range</label>
                    <p-floatlabel>
                        <p-datepicker inputId="declarationRange" [(ngModel)]="declarationRange" selectionMode="range"
                            [readonlyInput]="true" [showIcon]="true">
                        </p-datepicker>
                        <label for="declarationRange">Pick a range</label>
                    </p-floatlabel>
                </div>

                <!-- Pay date range -->
                <div class="control">
                    <label class="block mb-2 font-medium" for="payRange">Pay Date Range</label>
                    <p-floatlabel>
                        <p-datepicker inputId="payRange" [(ngModel)]="payRange" selectionMode="range"
                            [readonlyInput]="true" [showIcon]="true">
                        </p-datepicker>
                        <label for="payRange">Pick a range</label>
                    </p-floatlabel>
                </div>
            </div>
        </p-accordion-content>
    </p-accordion-panel>
</p-accordion>

<p-table [value]="rows" [paginator]="true" [rows]="pageSize" [rowsPerPageOptions]="rowsPerPageOptions"
    [totalRecords]="totalRecords()" [lazy]="true" (onPage)="onPage($event)" dataKey="id" class="dividends-table"
    [tableStyle]="{ 'min-width': '70rem' }">

    <ng-template pTemplate="caption">
        <div class="flex justify-between items-center w-full">
            <div class="flex items-center">
                <span class="font-medium">Ticker:</span>
                <span class="ml-2">{{ ticker || '—' }}</span>
                <span class="font-medium ml-6">Company:</span>
                <span class="ml-2">{{ company_name || '—' }}</span>
                <span class="font-medium ml-6">Total Dividends:</span>
                <span class="ml-2">{{ totalRecords() }}</span>
            </div>
            <p-iconfield iconPosition="left" class="ml-auto">
                <p-inputicon>
                    <i class="pi pi-search"></i>
                </p-inputicon>
                <input #searchBox pInputText type="text" [(ngModel)]="searchString"
                    (keyup.enter)="setSearch(searchString)" placeholder="Search keyword" />
                <p-inputicon class="pi pi-times cursor-pointer" (click)="clearSearch()"></p-inputicon>
            </p-iconfield>
        </div>
    </ng-template>

    <ng-template pTemplate="header">
        <tr>
            <th>Type</th>
            <th>Amount</th>
            <th>Freq</th>
            <th>Ex-Date</th>
            <th>Record</th>
            <th>Pay</th>
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-row>
        <tr>
            <td>{{ row.dividend_type }}</td>
            <td>{{ row.cash_amount | number:'1.2-4' }}</td>
            <td>{{ row.frequency }}</td>
            <td>{{ row.ex_dividend_date | date: 'yyyy-MM-dd' }}</td>
            <td>{{ row.record_date | date: 'yyyy-MM-dd' }}</td>
            <td>{{ row.pay_date | date: 'yyyy-MM-dd' }}</td>
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="7">No results.</td>
        </tr>
    </ng-template>
</p-table>
</div>