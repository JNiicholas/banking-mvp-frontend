<div>
  <h2 class="text-xl font-bold mb-4 mt-4">Screen by Year & Yield</h2>

  <!-- Controls -->
  <div class="controls mb-4 mt-4">
    <!-- Year (year-view datepicker) -->
    <div class="control">
      <label class="block mb-2 font-medium" for="yearPicker">Year</label>
      <p-datepicker
        inputId="yearPicker"
        [ngModel]="yearDate"
        (onSelect)="year = $event.getFullYear()"
        view="year"
        dateFormat="yy"
        [showIcon]="true"
      ></p-datepicker>
    </div>

    <!-- Min Yield -->
    <div class="control">
      <label class="block mb-2 font-medium" for="minYieldInput">Min Yield (%)</label>
      <input id="minYieldInput" type="text" pInputText [(ngModel)]="minYield" class="mb-2" />
      <p-slider [(ngModel)]="minYield" [min]="0" [max]="20" [step]="0.1"></p-slider>
    </div>

    <!-- Max Yield -->
    <div class="control">
      <label class="block mb-2 font-medium" for="maxYieldInput">Max Yield (%)</label>
      <input id="maxYieldInput" type="text" pInputText [(ngModel)]="maxYield" class="mb-2" />
      <p-slider [(ngModel)]="maxYield" [min]="0" [max]="20" [step]="0.1"></p-slider>
    </div>

    <!-- Actions -->
    <div class="control control-actions">
      <button
        pButton
        type="button"
        [label]="loading() ? 'Screening…' : 'Screen'"
        (click)="handleClick()"
        [disabled]="loading()"
      ></button>
      <button pButton type="button" class="p-button-text" label="Clear" (click)="clearScreener()"></button>
    </div>
  </div>

  @let r = result();

  @if (r) {
    <div class="overflow-x-auto w-full">
      <p-table
        [value]="r?.results ?? []"
        [paginator]="true"
        [rows]="pageSize"
        [first]="(page - 1) * pageSize"
        [totalRecords]="totalRecords()"
        [lazy]="true"
        (onPage)="onPage($event)"
        [rowsPerPageOptions]="[10, 25, 50, 100]"
        [tableStyle]="{ 'min-width': '80rem' }"
        [loading]="loading()"
        responsiveLayout="stack"
        breakpoint="700px"
        styleClass="dividends-table w-full"
      >
        <ng-template pTemplate="caption">
          <div class="flex items-center w-full">
            <span class="font-medium">Year:</span>
            <span class="ml-2">{{ r.year }}</span>
            <span class="ml-4">(Yield between {{ r.min_yield ?? '—' }}% and {{ r.max_yield ?? '—' }}%)</span>
            <span class="ml-auto">Total: {{ r.total }}</span>
          </div>
        </ng-template>

        <ng-template pTemplate="header">
          <tr>
            <th style="width: 14%">Ticker</th>
            <th style="width: 10%">Year</th>
            <th style="width: 12%">Payments</th>
            <th style="width: 14%">Year Div Sum</th>
            <th style="width: 14%">Yield %</th>
            <th style="width: 14%">Price Basis</th>
            <th style="width: 14%">Price Basis Date</th>
            <th style="width: 18%">Updated</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-row>
          <tr>
            <td data-label="Ticker">{{ row.ticker }}</td>
            <td data-label="Year">{{ row.year }}</td>
            <td data-label="Payments">{{ row.payments_count }}</td>
            <td data-label="Year Div Sum">{{ row.year_div_sum | number: '1.2-2' }}</td>
            <td data-label="Yield %">{{ row.year_yield | number: '1.2-2' }}</td>
            <td data-label="Price Basis">{{ row.price_basis | number: '1.2-2' }}</td>
            <td data-label="Price Basis Date">{{ row.price_basis_date | date: 'yyyy-MM-dd' }}</td>
            <td data-label="Updated">{{ row.updated_at | date: 'yyyy-MM-dd' }}</td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8">No results found.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  }
</div>