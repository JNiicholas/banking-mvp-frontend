<div >
<h2 class="text-xl font-bold mb-4 mt-4">Full Dividend History</h2>

  <div class="controls mb-4 mt-4">
    @if (!ticker) {
      <app-ticker-autocomplete [placeholder]="'Find ticker…'" [minLength]="1" [limit]="20" [disabled]="loadingTickers"
        (picked)="onTickerPicked($event)" (queryChange)="onQueryChanged($event)" (enter)="handleClick()" (cleared)="clearTicker()"></app-ticker-autocomplete>
    }

    <p-floatlabel class="w-full md:w-auto md:min-w-[260px]">
      <p-datepicker inputId="exRange" [(ngModel)]="rangeDates" selectionMode="range" [readonlyInput]="true" [showIcon]="true" [showButtonBar]="true" (ngModelChange)="onRangeChange($event)"></p-datepicker>
      <label for="exRange">Ex-Dividend Date Range</label>
    </p-floatlabel>

    @if (!ticker) {
      <button pButton type="submit" class="w-full md:w-auto" [label]="loading() ? 'Loading…' : 'Fetch Dividends'"
        (click)="handleClick()" [disabled]="loading()"></button>
    }
  </div>

  @let r = result();

  @if (r) {
    <!-- View toggle -->
    <div class="flex justify-end items-center mb-3">
      <p-toggleButton 
        [(ngModel)]="viewModeToggle" 
        onLabel="Chart" 
        offLabel="Table"
        onIcon="pi pi-chart-bar" 
        offIcon="pi pi-table" 
        class="w-40" 
        ariaLabel="Toggle Table/Chart View" />
    </div>

    @if (viewMode() === 'table') {
      <div #tablediv class="overflow-x-auto w-full mb-16">
        <p-table #dt [value]="r?.dividends ?? []" [paginator]="true" [rows]="pageSize" [first]="(page - 1) * pageSize"
          [totalRecords]="totalRecords()" [lazy]="true" (onPage)="onPage($event)" [rowsPerPageOptions]="[10, 25, 50]"
          [paginatorDropdownAppendTo]="tablediv" 
          [tableStyle]="{ 'min-width': '80rem' }" [loading]="loading()" responsiveLayout="stack" breakpoint="500px"
          styleClass="dividends-table w-full">
          <ng-template pTemplate="caption">
            <div class="flex justify-between items-center w-full">
              <div class="flex items-center">
                <span class="font-medium">Ticker:</span>
                <span class="ml-2">{{ r.ticker }}</span>
                <span class="font-medium ml-6">Company:</span>
                <span class="ml-2">{{ r.company_name }}</span>
                <span class="font-medium ml-6">Total Dividends:</span>
                <span class="ml-2">{{ r.total }}</span>
              </div>
              <p-iconfield iconPosition="left" class="ml-auto">
                <p-inputicon>
                  <i class="pi pi-search"></i>
                </p-inputicon>
                <input #searchBox pInputText type="text" [(ngModel)]="searchString" (keyup.enter)="setSearch(searchString)"
                  placeholder="Search keyword" />
                <p-inputicon class="pi pi-times cursor-pointer" (click)="clearSearch()"></p-inputicon>
              </p-iconfield>
            </div>
          </ng-template>
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 15%">Amount</th>
              <th style="width: 15%">Ex Date</th>
              <th style="width: 15%">Pay Date</th>
              <th class="col-record" style="width: 20%">Record Date</th>
              <th class="col-declaration" style="width: 20%">Declaration Date</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-d>
            <tr>
              <td data-label="Amount">
                {{ d.cash_amount }}
                @if (d?.currency) { <span class="ml-1">{{ d.currency }}</span> }
              </td>
              <td data-label="Ex Date">{{ d.ex_dividend_date | date:'yyyy-MM-dd' }}</td>
              <td data-label="Pay Date">{{ d.pay_date | date:'yyyy-MM-dd' }}</td>
              <td class="col-record" data-label="Record Date">{{ d.record_date | date:'yyyy-MM-dd' }}</td>
              <td class="col-declaration" data-label="Declaration Date">{{ d.declaration_date | date:'yyyy-MM-dd' }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6">No dividends found.</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    } @else if (viewMode() === 'chart') {
      <div class="h-[30rem]">
        <p-chart type="bar" [data]="chartData()" [options]="chartOptions()" class="h-full w-full" />
      </div>
    }
  }
</div>