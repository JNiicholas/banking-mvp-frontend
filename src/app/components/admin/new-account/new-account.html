<h2 class="mt-4 mb-3">New Account</h2>

<!-- Loading / Error states -->
@if (loading) {
  <div>Creating accountâ€¦</div>
} @else if (error) {
  <p-message severity="error" [text]="error"></p-message>
}

<!-- Success state: show the created account summary -->
@if (created) {
  <p-card
    [style]="{ 'background-color': '#0d1b2a', 'color': '#e0e0e0', 'border-radius': '8px', 'border': '1px solid #1e3a5f', 'padding': '1rem' }"
    styleClass="mb-3"
  >
    @let acc = created;
    <ng-template pTemplate="header">
      <div class="flex justify-between items-center">
        <div class="flex items-center">
          <i class="pi pi-wallet mr-2"></i>
          <span class="font-semibold text-lg">{{ acc?.ibanDisplay || acc?.ibanNormalized }}</span>
        </div>
        <div class="flex items-center">
          <span class="text-sm mr-2">Balance</span>
          <span class="font-bold text-xl">{{ acc?.balance | number:'1.2-2' }}</span>
          <span class="ml-1">EUR</span>
        </div>
      </div>
    </ng-template>

    <div class="text-sm opacity-80">
      Account successfully created for customer
      <strong>{{ createdCustomer?.firstName }} {{ createdCustomer?.lastName }}</strong>
      ({{ createdCustomer?.email }}).
    </div>

    <ng-template pTemplate="footer">
      <div class="flex gap-2">
        <button pButton type="button" icon="pi pi-list" label="View Transactions" class="p-button-outlined" (click)="goToAccount(acc?.id)"></button>
      </div>
    </ng-template>
  </p-card>
} @else {
  <!-- Account creation form -->
  <form [formGroup]="form" (ngSubmit)="create()" class="flex flex-col gap-3 max-w-xl">
    <p-card
      [style]="{ 'background-color': '#0d1b2a', 'color': '#e0e0e0', 'border-radius': '8px', 'border': '1px solid #1e3a5f', 'padding': '1rem' }"
      styleClass="mb-3"
    >
      <ng-template pTemplate="header">
        <div class="flex items-center">
          <i class="pi pi-user mr-2"></i>
          <span class="font-semibold">Select Customer</span>
        </div>
      </ng-template>

      <div class="field">
        <label for="customerAuto" class="block mb-1">Customer</label>
        <p-autocomplete
          [ngModel]="selectedCustomer"
          (ngModelChange)="selectedCustomer = $event"
          [ngModelOptions]="{standalone: true}"
          [suggestions]="suggestions"
          (completeMethod)="filterCustomers($event)"
          (onSelect)="onPickCustomer($event)"
          (onClear)="onClearCustomer()"
          [dropdown]="true"
          [forceSelection]="true"
          [showClear]="true"
          [minLength]="1"
          placeholder="Search by name or email"
          optionLabel="email"
          inputId="customerAuto"
          class="w-full"
        >
          <ng-template let-c pTemplate="item">
            <div class="flex items-center gap-2">
              <span class="font-medium">{{ c.firstName }} {{ c.lastName }}</span>
              <span class="text-sm opacity-80">{{ c.email }}</span>
            </div>
          </ng-template>

          <ng-template pTemplate="selectedItem" let-c>
            <div class="flex items-center gap-2">
              <span class="font-medium">{{ c?.firstName }} {{ c?.lastName }}</span>
              <span class="text-sm opacity-80">{{ c?.email }}</span>
            </div>
          </ng-template>
        </p-autocomplete>

        <!-- Keep the reactive form control in sync and validate -->
        <input type="hidden" formControlName="customerId" />
        @if (form.get('customerId')?.invalid && (form.get('customerId')?.dirty || form.get('customerId')?.touched)) {
          <small class="text-red-500">Please select a customer.</small>
        }
      </div>

      <ng-template pTemplate="footer">
        <div class="flex gap-2">
          <button pButton type="button" label="Cancel" class="p-button-text" (click)="cancel()"></button>
          <button pButton type="submit" icon="pi pi-wallet" label="Create Account" [disabled]="form.invalid || loading"></button>
        </div>
      </ng-template>
    </p-card>
  </form>
}
